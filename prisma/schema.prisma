// prisma/schema.prisma
datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  MANAGER
  STAFF
  SALE
}

enum RateCardStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductType {
  GENERAL
  TISI
  FDA
  SPECIAL
}

enum Transport {
  TRUCK
  SHIP
}

enum Unit {
  CBM
  KG
}

enum CostMode {
  AUTO
  MANUAL
}

enum CostRule {
  CBM
  KG
  MANUAL
  NONE
}

enum CommissionMethod {
  DIFF
  ONEPCT
  NONE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RECALC
  ACTIVATE
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Hashed password
  name      String?
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]
  rateCards RateCard[]
}

model Salesperson {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipments Shipment[]
  customers Customer[]
}

model Customer {
  id          String   @id @default(cuid())
  code        String   @unique // PR-014
  name        String?
  assignedSalespersonId String?
  assignedSalesperson   Salesperson? @relation(fields: [assignedSalespersonId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shipments   Shipment[]
}

model RateCard {
  id          String         @id @default(cuid())
  name        String
  status      RateCardStatus @default(DRAFT)
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rows        RateRow[]
  shipments   Shipment[]
}

model RateRow {
  id         String     @id @default(cuid())
  rateCardId String
  rateCard   RateCard   @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  productType ProductType

  // Rates per transport and unit
  truckCbm    Decimal    @default(0) @db.Decimal(12,2)
  truckKg     Decimal    @default(0) @db.Decimal(12,2)
  shipCbm     Decimal    @default(0) @db.Decimal(12,2)
  shipKg      Decimal    @default(0) @db.Decimal(12,2)

  @@unique([rateCardId, productType])
}

model Shipment {
  id        String   @id @default(cuid())
  dateIn    DateTime?
  monthKey  String?  // "YYYY-MM"
  trackingNo    String
  trackingBase  String?
  trackingSuffix Int?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  salespersonId String?
  salesperson   Salesperson? @relation(fields: [salespersonId], references: [id])

  productType ProductType
  transport   Transport

  weightKg Decimal? @db.Decimal(12,3)
  cbm      Decimal? @db.Decimal(12,3)

  sellBase Decimal? @db.Decimal(12,2)

  costMode   CostMode @default(AUTO)
  costManual Decimal? @db.Decimal(12,2)

  rateCardUsedId String?
  rateCardUsed   RateCard? @relation(fields: [rateCardUsedId], references: [id])

  costCbm   Decimal? @db.Decimal(12,2)
  costKg    Decimal? @db.Decimal(12,2)
  costFinal Decimal? @db.Decimal(12,2)
  costRule  CostRule @default(NONE)

  commissionMethod CommissionMethod @default(NONE)
  commissionValue  Decimal? @db.Decimal(12,2)

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([monthKey])
  @@index([trackingBase])
  @@index([customerId])
  @@index([salespersonId])
  @@index([rateCardUsedId])
}

model AuditLog {
  id          String      @id @default(cuid())
  actorUserId String?
  actorUser   User?       @relation(fields: [actorUserId], references: [id])

  entityType  String
  entityId    String
  action      AuditAction
  message     String?
  beforeJson  Json?
  afterJson   Json?
  createdAt   DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}
