// prisma/schema.prisma
datasource db { provider = "postgresql"; url = env("DATABASE_URL") }
generator client { provider = "prisma-client-js" }

enum Role { ADMIN MANAGER STAFF SALE }
enum RateCardStatus { DRAFT ACTIVE ARCHIVED }
enum ProductType { GENERAL TISI FDA SPECIAL } // ทั่วไป มอก อย พิเศษ
enum Transport { TRUCK SHIP }                // รถ เรือ
enum Unit { CBM KG }
enum CostMode { AUTO MANUAL }
enum CostRule { CBM KG MANUAL NONE }
enum CommissionMethod { DIFF ONEPCT NONE }
enum AuditAction { CREATE UPDATE DELETE RECALC ACTIVATE }

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]
  // Added relations that were missing in user's snippet but required for compilation if referred back
  // The user's snippet shows `createdBy User?` in RateCard, so we need the reverse relation or just let Prisma infer/ignore if not explicit side.
  // Prisma usually requires the other side for the relation, or the attribute `@relation` properly set.
  // In user's snippet:
  // RateCard has `createdBy User? @relation(fields: [createdById], references: [id])`
  // So User needs `rateCards RateCard[]` if we want to navigate from User to RateCards, or we can omit it if not needed.
  // However, strict Prisma usually likes the back relation. The user text didn't show it but "Shipment" has "salesperson" relation etc.
  // Let's rely on what the user provided. If Prisma complains about missing back-relations, I will add them.
  // Actually, looking at the provided snippet:
  // `User` has `auditLogs AuditLog[]`
  // It doesn't explicitly list `rateCards` or `shipments`. I will add them to be safe and cleaner.
  rateCards RateCard[]
}

model Salesperson {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipments Shipment[]
  customers Customer[] // Added this back-relation
}

model Customer {
  id          String   @id @default(cuid())
  code        String   @unique // PR-014
  name        String?
  assignedSalespersonId String?
  assignedSalesperson   Salesperson? @relation(fields: [assignedSalespersonId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shipments   Shipment[]
}

model RateCard {
  id          String         @id @default(cuid())
  name        String
  status      RateCardStatus @default(DRAFT)
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rows        RateRow[]
  shipments   Shipment[] // shipments that used this card
}

model RateRow {
  id         String     @id @default(cuid())
  rateCardId String
  rateCard   RateCard   @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  productType ProductType
  transport   Transport
  unit        Unit
  rateValue   Decimal    @db.Decimal(12,2)

  @@unique([rateCardId, productType, transport, unit])
}

model Shipment {
  id        String   @id @default(cuid())
  dateIn    DateTime?
  monthKey  String?  // "YYYY-MM" (ทำ index/filter เร็ว)
  trackingNo    String
  trackingBase  String?
  trackingSuffix Int?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  salespersonId String?
  salesperson   Salesperson? @relation(fields: [salespersonId], references: [id])

  productType ProductType
  transport   Transport

  weightKg Decimal? @db.Decimal(12,3)
  cbm      Decimal? @db.Decimal(12,3)

  sellBase Decimal? @db.Decimal(12,2)

  costMode   CostMode @default(AUTO)
  costManual Decimal? @db.Decimal(12,2)

  rateCardUsedId String?       // ✅ ล็อกเรทที่ใช้
  rateCardUsed   RateCard? @relation(fields: [rateCardUsedId], references: [id])

  costCbm   Decimal? @db.Decimal(12,2)
  costKg    Decimal? @db.Decimal(12,2)
  costFinal Decimal? @db.Decimal(12,2)
  costRule  CostRule @default(NONE)

  commissionMethod CommissionMethod @default(NONE)
  commissionValue  Decimal? @db.Decimal(12,2)

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([monthKey])
  @@index([trackingBase])
  @@index([customerId])
  @@index([salespersonId])
  @@index([rateCardUsedId])
}

model AuditLog {
  id          String      @id @default(cuid())
  actorUserId String?
  actorUser   User?       @relation(fields: [actorUserId], references: [id])

  entityType  String
  entityId    String
  action      AuditAction
  message     String?
  beforeJson  Json?
  afterJson   Json?
  createdAt   DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}
